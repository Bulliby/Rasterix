<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>Hello, world!</title>
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <meta name="description" content="" />
        <link rel="icon" href="favicon.png">
    </head>
    <div class="container">
        <img id="render" title="Rasterix render window"></iframe>
        <form id="rangesForm" class="form">
            <label for="x-rotation">Rotation X</label>
            <x-range id="x-rotation" name="x-rotation" min="0.0" max="3.2" step="0.001"></x-range>
            <label for="y-rotation">Rotation Y</label>
            <x-range id="y-rotation" name="y-rotation" min="0.0" max="3.2" step="0.001"></x-range>
            <label for="z-rotation">Rotation Z</label>
            <x-range id="z-rotation" name="z-rotation" min="0.0" max="3.2" step="0.001"></x-range>
            <label for="x-translation">Translation X</label>
            <x-range id="x-translation" name="x-translation" min="-224" max="224" step="1"></x-range>
            <label for="y-translation">Translation Y</label>
            <x-range id="y-translation" name="y-translation" min="-224" max="224" step="1"></x-range>
            <label for="scale">Scale</label>
            <x-range id="scale" name="scale" min="1" max="890" step="1"></x-range>
        </form>
    </div>
</html>

<!-- Style need to be before javascript to get the size of element (fit-content) -->
<style>
* {
    margin-block-start: 0;
    margin-block-end: 0;
}

body {
    margin: 0;
    overflow: hidden;
}

.container {
    display: flex;
    margin: auto;
}

.form {
    width: 10%;
    display: flex;
    flex-direction: column; 
}
</style>

<script>
let form = document.getElementById('rangesForm');
let width = window.innerWidth - form.offsetWidth;
let height = window.innerHeight;

const URL = document.location.origin + '/rasterix.php';
document.getElementById('render').setAttribute('src', URL);
document.getElementById('render').setAttribute('width', height);
document.getElementById('render').setAttribute('height', height);

let size = JSON.stringify({'x' : height, 'y': height});
const formData = new FormData();
formData.append(`screen-size`, size) 

fetch(URL, { method: 'POST', body: formData })
    .then(() => {
        document.getElementById('render').setAttribute('src', URL + '?t=' + new Date().getTime());
    });

</script>

<script type="module">
import { defineCustomElement } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js'
const Range = defineCustomElement({
    props: {
        name: String, 
        min: Number,
        max: Number,
        step: Number,
    },
    data () {
        return  {
            range: 0,
            url: URL,
            timer: null,
        }
    },
    methods: {
        generate() {
            if (this.timer) {
                clearTimeout(this.timer);
            }
            this.timer = setTimeout(() => {
                const formData = new FormData();
                formData.append(`${this.name}`, this.range) 
                fetch(this.url, { method: 'POST', body: formData })
                    .then(() => {
                        formData.delete(`${this.name}`) 
                        document.getElementById('render').setAttribute('src', URL + '?t=' + new Date().getTime());
                    });
            }, 100);
        }
    },
    /**
         * Fetch the current value in SESSION for ranges inout.
         */
    created() {
        const formData = new FormData();
        formData.append("get-range", `${this.name}`) 
        fetch(this.url, { method: 'POST', body: formData })
            .then((r) => r.json())
            .then((data) => {
                this.range = data;
            });
    },
    template: `<input type="range" v-model.number="range" @input="generate" :min="min" :max="max" :step="step"/>`,

    // defineCustomElement only: CSS to be injected into shadow root
    styles: [`/* inlined css */`]
})

// Register the custom element.
// After registration, all `<x-range>` tags
// on the page will be upgraded.
customElements.define('x-range', Range)
</script>
